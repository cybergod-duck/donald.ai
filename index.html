<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donald.AI</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        #frame {
            width: 800px;
            height: 450px;
            border: 2px solid #0f0;
            position: relative;
            background: #000;
            box-shadow: 0 0 20px #0f0;
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        #frame-header {
            color: #0f0;
            font-size: 1rem;
            padding: 8px 12px;
            border-bottom: 1px solid #0f0;
            background: #000;
        }
        #visual {
            width: 100%;
            height: 100%;
            object-fit: cover;
            flex: 1;
            transition: opacity 0.15s ease-in-out;
        }
        #frame::after {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 50;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        .load-bar {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 60px; height: 8px;
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #0f0;
            z-index: 100;
            display: none;
        }
        .load-bar.active { display: block; }
        #load-progress { height: 100%; background: #0f0; width: 0; transition: width 0.2s linear; }
        #load-text {
            position: absolute;
            top: calc(50% - 30px);
            left: 50%;
            transform: translateX(-50%);
            color: #0f0;
            z-index: 100;
            display: none;
            text-shadow: 0 0 10px #0f0;
        }
        #load-text.active { display: block; }
        #terminal {
            width: 800px;
            margin-top: 15px;
            border: 1px solid #0f0;
            padding: 10px;
            background: #000;
        }
        #cmd {
            background: transparent;
            border: none;
            color: #0f0;
            width: 95%;
            font-size: 1.2rem;
            outline: none;
            font-family: inherit;
        }
        .title h1 {
            font-size: 3rem;
            color: #0066cc;
            text-shadow: 0 0 15px #0066cc;
            margin: 0;
            text-align: center;
        }
        #random-btn {
            margin-top: 15px;
            background: transparent;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 12px 30px;
            cursor: pointer;
            box-shadow: 0 0 10px #0f0;
        }
        #random-btn:hover { background: #0f0; color: #000; }
        .keyboard-hint { color: #0066cc; margin: 20px 0; text-align: center; font-weight: bold; }
        @keyframes flash-white {
            0% { filter: brightness(1); }
            50% { filter: brightness(3); }
            100% { filter: brightness(1); }
        }
        .flash-transition { animation: flash-white 0.4s ease-out; }
    </style>
</head>
<body>
    <div class="title"><h1>Donald.AI</h1></div>
    <div id="frame">
        <div id="frame-header">Donald.AI Status: STANDBY</div>
        <div class="load-bar" id="load-bar"><div id="load-progress"></div></div>
        <div id="load-text">GENERATING...</div>
        <video id="visual" muted loop playsinline preload="auto"></video>
    </div>
    <div id="terminal"><span><input type="text" id="cmd" placeholder="Ask for a speech..." autocomplete="off"></span></div>
    <button id="random-btn">RANDOM SPEECH</button>
    <div class="keyboard-hint">SPACE: Pause | M: Mute | ESC: Stop</div>

    <audio id="ambient" loop src="https://raw.githubusercontent.com/cybergod-duck/donald.ai/main/drone.mp3"></audio>
    <audio id="click-sound" src="https://raw.githubusercontent.com/cybergod-duck/donald.ai/main/click.mp3"></audio>

    <script>
        const GITHUB_BASE = 'https://raw.githubusercontent.com/cybergod-duck/donald.ai/main/';
        const input = document.getElementById('cmd');
        const visual = document.getElementById('visual');
        const ambient = document.getElementById('ambient');
        const loadBar = document.getElementById('load-bar');
        const loadProgress = document.getElementById('load-progress');
        const loadText = document.getElementById('load-text');
        
        let audioContext, analyser, currentSpeechAudio;
        let isIdle = true;
        let lastVideo = null;

        const mouthShapes = {
            wideopen: ['wide1.mp4', 'wide2.mp4', 'wide3.mp4', 'wide4.mp4', 'wide5.mp4', 'express1.mp4', 'express2.mp4'],
            open: ['express3.mp4', 'express4.mp4', 'express5.mp4', '1.mp4', '2.mp4', '7.mp4'],
            narrow: ['express6.mp4', '3.mp4', '4.mp4', '5.mp4', '6.mp4'],
            closed: ['pause1.mp4', 'pause2.mp4', 'pause3.mp4', 'pause4.mp4', 'pause5.mp4'],
            neutral: ['8.mp4', '9.mp4', '10.mp4', '11.mp4', '12.mp4', '13.mp4', '14.mp4']
        };

        const systemPrompt = "You are Donald Trump. Give a short, boastful speech. Use 'tremendous', 'believe me', and 'fake news'.";

        function playRandomCheer() {
            const cheerNum = Math.floor(Math.random() * 5) + 1;
            const cheer = new Audio(`${GITHUB_BASE}cheer${cheerNum}.mp3`);
            cheer.volume = 0.4;
            cheer.play().catch(() => {});
        }

        function loadIdleVideo() {
            visual.src = GITHUB_BASE + 'idle.mp4';
            visual.loop = true;
            visual.play().catch(() => {});
        }

        async function processPrompt() {
            const prompt = input.value.trim();
            if (!prompt || !isIdle) return;

            isIdle = false;
            input.disabled = true;
            loadBar.classList.add('active');
            loadText.classList.add('active');

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, fullPrompt: systemPrompt })
                });
                
                const data = await res.json();
                const audioBlob = new Blob([Uint8Array.from(atob(data.audio), c => c.charCodeAt(0))], { type: 'audio/mpeg' });
                const url = URL.createObjectURL(audioBlob);
                
                const audio = new Audio(url);
                currentSpeechAudio = audio;

                if (!audioContext) {
                    audioContext = new AudioContext();
                    analyser = audioContext.createAnalyser();
                    const source = audioContext.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                }

                audio.onplay = () => {
                    loadBar.classList.remove('active');
                    loadText.classList.remove('active');
                    ambient.volume = 0.1;
                    startLipSync();
                };

                audio.onpause = () => playRandomCheer();
                
                audio.onended = () => {
                    isIdle = true;
                    input.disabled = false;
                    playRandomCheer();
                    switchVideo('end.mp4', false);
                    visual.onended = () => loadIdleVideo();
                };

                audio.play();
            } catch (e) {
                console.error(e);
                isIdle = true;
                input.disabled = false;
            }
        }

        function switchVideo(file, loop = false) {
            if (lastVideo === file) return;
            visual.style.opacity = '0.5';
            setTimeout(() => {
                visual.src = GITHUB_BASE + file;
                visual.loop = loop;
                visual.play();
                visual.style.opacity = '1';
                lastVideo = file;
            }, 50);
        }

        function startLipSync() {
            const freqData = new Uint8Array(analyser.frequencyBinCount);
            let lastSwitch = 0;

            function frame() {
                if (isIdle || currentSpeechAudio.paused) return;
                analyser.getByteFrequencyData(freqData);
                const volume = freqData.reduce((a, b) => a + b) / freqData.length;
                const now = Date.now();

                if (now - lastSwitch > 250) { // Swaps clips every 250ms for snappier look
                    let shape = 'neutral';
                    if (volume < 5) shape = 'closed';
                    else if (volume > 40) shape = 'wideopen';
                    else if (volume > 25) shape = 'open';
                    else if (volume > 10) shape = 'narrow';

                    const options = mouthShapes[shape];
                    const pick = options[Math.floor(Math.random() * options.length)];
                    switchVideo(pick);
                    lastSwitch = now;
                }
                requestAnimationFrame(frame);
            }
            frame();
        }

        input.onkeydown = (e) => { if (e.key === 'Enter') processPrompt(); };
        window.onload = loadIdleVideo;
        document.body.onclick = () => { ambient.play(); };
    </script>
</body>
</html>
